<script setup lang="ts">
import { ref, onMounted } from 'vue'
import { useRoute } from 'vue-router'
import TitleWrapper from '@/components/ui/TitleWrapper.vue'
import SideMenu from '@/components/layout/SideMenu.vue'

interface Message {
  id: number
  text: string
  isAssistant: boolean
  date: string
}

const route = useRoute()
const questionId = Number(route.params.id)

// –ò–º–∏—Ç–∞—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö –¥–∏–∞–ª–æ–≥–∞
const dialog = ref<{
  assistantName: string
  assistantAvatar: string
  question: string
  messages: Message[]
}>({
  assistantName: '–ê–ª–µ–∫—Å–∞–Ω–¥—Ä',
  assistantAvatar: 'üë®üèª‚Äçüíº',
  question: '–ö–∞–∫ —É–ª—É—á—à–∏—Ç—å —Ç–æ—á–Ω–æ—Å—Ç—å –º–æ–∏—Ö –æ—Ç–≤–µ—Ç–æ–≤ –Ω–∞ —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ –≤–æ–ø—Ä–æ—Å—ã?',
  messages: [
    {
      id: 1,
      text: '–ö–∞–∫ —É–ª—É—á—à–∏—Ç—å —Ç–æ—á–Ω–æ—Å—Ç—å –º–æ–∏—Ö –æ—Ç–≤–µ—Ç–æ–≤ –Ω–∞ —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ –≤–æ–ø—Ä–æ—Å—ã?',
      isAssistant: false,
      date: '2024-03-05 10:00'
    },
    {
      id: 2,
      text: '–ó–¥—Ä–∞–≤—Å—Ç–≤—É–π—Ç–µ! –Ø –ø–æ–º–æ–≥—É –≤–∞–º —É–ª—É—á—à–∏—Ç—å —Ç–æ—á–Ω–æ—Å—Ç—å –æ—Ç–≤–µ—Ç–æ–≤. –î–ª—è –Ω–∞—á–∞–ª–∞, —Ä–∞—Å—Å–∫–∞–∂–∏—Ç–µ, —Å –∫–∞–∫–∏–º–∏ –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–º–∏ —Ç—Ä—É–¥–Ω–æ—Å—Ç—è–º–∏ –≤—ã —Å—Ç–∞–ª–∫–∏–≤–∞–µ—Ç–µ—Å—å?',
      isAssistant: true,
      date: '2024-03-05 10:01'
    },
    {
      id: 3,
      text: '–ò–Ω–æ–≥–¥–∞ –º–æ–∏ –æ—Ç–≤–µ—Ç—ã —Å–ª–∏—à–∫–æ–º –æ–±—â–∏–µ, –∏ —è –Ω–µ –≤—Å–µ–≥–¥–∞ —É–≤–µ—Ä–µ–Ω –≤ –∞–∫—Ç—É–∞–ª—å–Ω–æ—Å—Ç–∏ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏',
      isAssistant: false,
      date: '2024-03-05 10:03'
    },
    {
      id: 4,
      text: '–ü–æ–Ω—è—Ç–Ω–æ. –î–ª—è —É–ª—É—á—à–µ–Ω–∏—è —Ç–æ—á–Ω–æ—Å—Ç–∏ –æ—Ç–≤–µ—Ç–æ–≤ —Ä–µ–∫–æ–º–µ–Ω–¥—É—é —Å–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏:\n1) –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –±–æ–ª–µ–µ —Ç–æ—á–Ω—ã–µ –ø—Ä–æ–º–ø—Ç—ã —Å –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–º–∏ –ø–∞—Ä–∞–º–µ—Ç—Ä–∞–º–∏\n2) –ü—Ä–æ–≤–µ—Ä—è—Ç—å –∏—Å—Ç–æ—á–Ω–∏–∫–∏ –¥–∞–Ω–Ω—ã—Ö –Ω–∞ –∞–∫—Ç—É–∞–ª—å–Ω–æ—Å—Ç—å\n3) –†–µ–≥—É–ª—è—Ä–Ω–æ –æ–±–Ω–æ–≤–ª—è—Ç—å –±–∞–∑—É –∑–Ω–∞–Ω–∏–π\n4) –ó–∞–ø—Ä–∞—à–∏–≤–∞—Ç—å –æ–±—Ä–∞—Ç–Ω—É—é —Å–≤—è–∑—å –æ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π',
      isAssistant: true,
      date: '2024-03-05 10:05'
    },
    {
      id: 5,
      text: '–°–ø–∞—Å–∏–±–æ! –ê –∫–∞–∫ –ª—É—á—à–µ —Å–æ—Å—Ç–∞–≤–ª—è—Ç—å –ø—Ä–æ–º–ø—Ç—ã –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –±–æ–ª–µ–µ —Ç–æ—á–Ω—ã—Ö –æ—Ç–≤–µ—Ç–æ–≤?',
      isAssistant: false,
      date: '2024-03-05 10:07'
    },
    {
      id: 6,
      text: '–ü—Ä–∏ —Å–æ—Å—Ç–∞–≤–ª–µ–Ω–∏–∏ –ø—Ä–æ–º–ø—Ç–æ–≤ –≤–∞–∂–Ω–æ:\n1) –£–∫–∞–∑—ã–≤–∞—Ç—å –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–π –∫–æ–Ω—Ç–µ–∫—Å—Ç –∑–∞–¥–∞—á–∏\n2) –û–ø—Ä–µ–¥–µ–ª—è—Ç—å –∂–µ–ª–∞–µ–º—ã–π —Ñ–æ—Ä–º–∞—Ç –æ—Ç–≤–µ—Ç–∞\n3) –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞—Ç—å –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è –∏ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è\n4) –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –ø—Ä–∏–º–µ—Ä—ã –¥–ª—è –∏–ª–ª—é—Å—Ç—Ä–∞—Ü–∏–∏\n–•–æ—Ç–∏—Ç–µ, —è –ø–æ–∫–∞–∂—É –Ω–µ—Å–∫–æ–ª—å–∫–æ –ø—Ä–∏–º–µ—Ä–æ–≤ —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω—ã—Ö –ø—Ä–æ–º–ø—Ç–æ–≤?',
      isAssistant: true,
      date: '2024-03-05 10:09'
    }
  ]
})

const newMessage = ref('')

const sendMessage = () => {
  if (!newMessage.value.trim()) return

  dialog.value.messages.push({
    id: dialog.value.messages.length + 1,
    text: newMessage.value,
    isAssistant: false,
    date: new Date().toISOString()
  })

  newMessage.value = ''
}

const isHistoryCollapsed = ref(true)

const toggleHistory = () => {
  isHistoryCollapsed.value = !isHistoryCollapsed.value
}

onMounted(() => {
  // –ó–¥–µ—Å—å –±—É–¥–µ—Ç –∑–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö –¥–∏–∞–ª–æ–≥–∞ –ø–æ ID
})
</script>

<template>
  <div class="dialog-page">
    <SideMenu />
    
    <div class="dialog-main">
      <TitleWrapper 
        title="–î–∏–∞–ª–æ–≥"
        :subtitle="dialog.question"
      />
      
      <div class="dialog-container">
        <div 
          class="dialog-history"
          :class="{ 'dialog-history--collapsed': isHistoryCollapsed }"
        >
          <div 
            class="dialog-history__header"
            @click="toggleHistory"
          >
            <div class="dialog-history__title">
              –ò—Å—Ç–æ—Ä–∏—è –¥–∏–∞–ª–æ–≥–∞
              <span class="dialog-history__title-arrow">‚Üì</span>
            </div>
          </div>
          <div class="dialog-history__date">
            {{ new Date(dialog.messages[0].date).toLocaleDateString('ru-RU', { day: 'numeric', month: 'long', year: 'numeric' }) }}
          </div>
          <div class="dialog-history__messages">
            <div 
              v-for="message in dialog.messages" 
              :key="message.id"
              class="dialog-history__message"
              :class="{ 'dialog-history__message--assistant': message.isAssistant }"
            >
              <div class="dialog-history__message-author">
                {{ message.isAssistant ? `–ê—Å—Å–∏—Å—Ç–µ–Ω—Ç ${dialog.assistantName}` : '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å' }}
              </div>
              <div class="dialog-history__message-text">{{ message.text }}</div>
              <div class="dialog-history__message-time">
                {{ new Date(message.date).toLocaleTimeString('ru-RU', { hour: '2-digit', minute: '2-digit' }) }}
              </div>
            </div>
          </div>
        </div>

        <div class="messages-list">
          <div 
            v-for="message in dialog.messages" 
            :key="message.id"
            class="message"
            :class="{ 'message--assistant': message.isAssistant }"
          >
            <div class="message__avatar" v-if="message.isAssistant">
              {{ dialog.assistantAvatar }}
            </div>
            <div class="message__content">
              <div class="message__name" v-if="message.isAssistant">
                –ê—Å—Å–∏—Å—Ç–µ–Ω—Ç {{ dialog.assistantName }}
              </div>
              <div class="message__text">{{ message.text }}</div>
              <div class="message__date">
                {{ new Date(message.date).toLocaleString('ru-RU') }}
              </div>
            </div>
          </div>
        </div>
        
        <div class="form-container">
          <div class="assistant-info">
            <div class="assistant-avatar">{{ dialog.assistantAvatar }}</div>
            <div class="assistant-name">{{ dialog.assistantName }}</div>
          </div>
          
          <div class="message-form">
            <textarea
              v-model="newMessage"
              placeholder="–í–≤–µ–¥–∏—Ç–µ –≤–∞—à –æ—Ç–≤–µ—Ç..."
              class="message-input"
              rows="2"
            ></textarea>
            <button 
              class="send-button"
              @click="sendMessage"
              :disabled="!newMessage.trim()"
            >
              –û—Ç–ø—Ä–∞–≤–∏—Ç—å
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>
</template>

<style scoped lang="scss">
.dialog-page {
  width: 100%;
  min-height: 100vh;
  display: flex;
}

.dialog-main {
  flex: 1;
  padding: 20px;
  display: flex;
  flex-direction: column;
  gap: 24px;
  background: #F9FAFB;
  min-height: 100vh;
  position: relative;
  max-width: 1200px;
  margin: 0 auto;
}

.dialog-container {
  flex: 1;
  display: flex;
  flex-direction: column;
  gap: 24px;
  border-radius: 12px;
  padding-bottom: 120px;
  position: relative;
}

.dialog-history {
  padding: 24px;
  display: flex;
  flex-direction: column;
  gap: 16px;
  background: rgba(243, 244, 246, 0.5);
  border-radius: 12px;
  transition: all 0.3s ease;
  
  &--collapsed {
    .dialog-history__messages,
    .dialog-history__date {
      display: none;
    }
    
    .dialog-history__title-arrow {
      transform: rotate(-90deg);
    }
  }
}

.dialog-history__header {
  display: flex;
  align-items: center;
  gap: 8px;
  cursor: pointer;
  user-select: none;
}

.dialog-history__title {
  font-size: 24px;
  font-weight: 600;
  color: #111827;
  display: flex;
  align-items: center;
  gap: 8px;
}

.dialog-history__title-arrow {
  font-size: 20px;
  transition: transform 0.3s ease;
}

.dialog-history__date {
  font-size: 16px;
  color: #6B7280;
  padding-bottom: 16px;
  border-bottom: 1px solid #E5E7EB;
}

.dialog-history__messages {
  display: flex;
  flex-direction: column;
  gap: 20px;
}

.dialog-history__message {
  display: flex;
  flex-direction: column;
  gap: 8px;
  padding: 16px;
  background: white;
  border-radius: 12px;
  width: 50%;
  align-self: flex-end;
}

.dialog-history__message--assistant {
  align-self: flex-start;
  background: #F3F4F6;
}

.dialog-history__message-author {
  font-size: 14px;
  font-weight: 600;
  color: #6B7280;
}

.dialog-history__message-text {
  font-size: 16px;
  line-height: 1.6;
  color: #374151;
  white-space: pre-wrap;
}

.dialog-history__message-time {
  font-size: 12px;
  color: #9CA3AF;
  align-self: flex-end;
}

.messages-list {
  padding: 20px;
  padding-bottom: 120px;
  display: flex;
  flex-direction: column;
  gap: 16px;
}

.message {
  display: flex;
  gap: 12px;
  width: 50%;

  &--assistant {
    align-self: flex-start;
  }

  &:not(.message--assistant) {
    align-self: flex-end;
    flex-direction: row-reverse;
  }
}

.message__avatar {
  width: 36px;
  height: 36px;
  display: flex;
  align-items: center;
  justify-content: center;
  background: #F3F4F6;
  border-radius: 50%;
  font-size: 24px;
  flex-shrink: 0;
}

.message__content {
  flex: 1;
  background: rgba(243, 244, 246, 0.8);
  padding: 12px 16px;
  border-radius: 12px;
  position: relative;
  box-shadow: 0 1px 2px rgba(0, 0, 0, 0.05);
  backdrop-filter: blur(8px);
}

.message__name {
  font-size: 14px;
  font-weight: 500;
  color: #6B7280;
  margin-bottom: 4px;
}

.message:not(.message--assistant) .message__content {
  background: rgba(228, 167, 162, 0.8);
  color: white;
  box-shadow: 0 1px 2px rgba(228, 167, 162, 0.2);
  backdrop-filter: blur(8px);
}

.message__text {
  margin-bottom: 4px;
  line-height: 1.5;
}

.message__date {
  font-size: 12px;
  color: #6B7280;
}

.message:not(.message--assistant) .message__date {
  color: rgba(255, 255, 255, 0.8);
}

.form-container {
  display: flex;
  flex-direction: column;
  gap: 8px;
  position: absolute;
  bottom: 0;
  left: 0;
  right: 0;
  background: #F9FAFB;
  padding: 16px 20px;
}

.assistant-info {
  display: flex;
  align-items: center;
  gap: 12px;
  padding: 0 12px;
}

.assistant-avatar {
  width: 40px;
  height: 40px;
  display: flex;
  align-items: center;
  justify-content: center;
  background: #F3F4F6;
  border-radius: 50%;
  font-size: 28px;
}

.assistant-name {
  font-size: 18px;
  font-weight: 600;
  color: #374151;
}

.message-form {
  padding: 8px;
  display: flex;
  gap: 12px;
}

.message-input {
  flex: 1;
  padding: 8px;
  border: 1px solid #E5E7EB;
  border-radius: 8px;
  resize: none;
  font-family: inherit;
  font-size: 14px;
  line-height: 1.5;

  &:focus {
    outline: none;
    border-color: #E4A7A2;
  }
}

.send-button {
  padding: 0 16px;
  background: #E4A7A2;
  color: white;
  border: none;
  border-radius: 8px;
  font-weight: 500;
  cursor: pointer;
  transition: all 0.2s ease;

  &:hover:not(:disabled) {
    background: rgba(228, 167, 162, 0.9);
  }

  &:disabled {
    background: #D1D5DB;
    cursor: not-allowed;
  }
}
</style> 